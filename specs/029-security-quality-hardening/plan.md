# Implementation Plan: Security & Quality Hardening

**Branch**: `029-security-quality-hardening` | **Date**: 2026-02-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/029-security-quality-hardening/spec.md`

## Summary

Address 6 categories of findings from a comprehensive code review (health score 6.1/10): sensitive data redaction in test evidence persistence/export, credential prompt wiring, path traversal prevention, resource lifecycle management (event unsubscription and CTS disposal), async file I/O in history service, and theme hardcoded color replacement.

## Technical Context

**Language/Version**: C# 12 / .NET 8.0-windows
**Primary Dependencies**: WPF-UI 4.2.0, CommunityToolkit.Mvvm 8.4.0, System.Text.Json
**Storage**: JSON files in `%LOCALAPPDATA%/ReqChecker/` (history.json), Windows Credential Manager (credentials)
**Testing**: Manual verification per quickstart.md
**Target Platform**: Windows 10+ (WPF desktop application)
**Project Type**: Single solution with 3 projects (Core, Infrastructure, App)

## Constitution Check

No constitution gates defined. Proceeding directly.

## Project Structure

### Documentation (this feature)

```text
specs/029-security-quality-hardening/
├── spec.md
├── plan.md              # This file
├── research.md          # Research decisions
├── quickstart.md        # Verification steps
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── ReqChecker.Core/
│   ├── Interfaces/        # ITestRunner, ICredentialProvider, IProfileStorageService
│   ├── Models/            # TestResult, TestEvidence, RunReport
│   └── Services/          # NEW: TestResultSanitizer.cs
├── ReqChecker.Infrastructure/
│   ├── Execution/         # SequentialTestRunner, RetryPolicy (no changes)
│   ├── Export/            # JsonExporter, CsvExporter, PdfExporter (add sanitizer calls)
│   ├── History/           # HistoryService (sanitizer + async I/O)
│   └── Profile/           # ProfileStorageService (path validation)
└── ReqChecker.App/
    ├── App.xaml.cs        # Credential prompt wiring
    ├── ViewModels/        # MainViewModel, DiagnosticsViewModel, RunProgressViewModel (lifecycle fixes)
    └── Resources/Styles/  # Theme.xaml (replace hardcoded colors)
```

**Structure Decision**: Existing 3-project structure (Core/Infrastructure/App) is maintained. The only new file is `TestResultSanitizer.cs` in Core/Services — a pure static utility with no dependencies.

---

## Implementation Details

### User Story 1 — Sensitive Data Redaction (FR-001, FR-002)

**Goal**: Strip sensitive fields from TestResult before persisting to history or exporting to reports.

**New file**: `src/ReqChecker.Core/Services/TestResultSanitizer.cs`
- Static class with `SanitizeForPersistence(RunReport report)` method
- Deep-clones the RunReport, then for each `TestResult.Evidence`:
  - `ResponseData` → `"[REDACTED — {length} chars]"` (if non-null)
  - `FileContent` → `"[REDACTED — {length} chars]"` (if non-null)
  - `ResponseHeaders` → remove `Authorization`, `Set-Cookie`, `X-Api-Key`, `Cookie` keys
- Also truncates `TestResult.TechnicalDetails` to 500 chars
- Returns the sanitized clone (original RunReport is not modified)

**Modified files**:
- `HistoryService.SaveRunAsync()` — call `TestResultSanitizer.SanitizeForPersistence(report)` before adding to `_history` and saving
- `JsonExporter`, `CsvExporter`, `PdfExporter` — call sanitizer on the RunReport before generating output

**Key detail**: Sanitization creates a clone so the in-memory `RunReport` (used by the Results page, diagnostics, etc.) retains full data. Only the persisted/exported copy is redacted.

### User Story 2 — Credential Prompt Wiring (FR-003, FR-004)

**Goal**: Connect the existing `CredentialPromptViewModel` to the `SequentialTestRunner.PromptForCredentials` callback.

**Modified file**: `src/ReqChecker.App/App.xaml.cs`
- After `Services = services.BuildServiceProvider()` in `ConfigureServices()`:
  - Resolve `ITestRunner` and cast to `SequentialTestRunner`
  - Assign `PromptForCredentials` callback that:
    1. Dispatches to UI thread
    2. Creates `CredentialPromptViewModel`, calls `Initialize()`
    3. Shows a `ContentDialog` with the credential prompt content
    4. Uses `TaskCompletionSource<(string?, string?)>` to bridge async
    5. Returns `(username, password)` on submit, or `(null, null)` on cancel

**Existing behavior when `PromptForCredentials` returns nulls**: `SequentialTestRunner.PromptForCredentialsIfNeededAsync()` line 211 returns `TestExecutionContext("", "")` which causes the test to fail with auth error. We should modify the runner to return a skip result when credentials are null (FR-004).

**Modified file**: `src/ReqChecker.Infrastructure/Execution/SequentialTestRunner.cs`
- In `PromptForCredentialsIfNeededAsync()`, after the prompt returns, check if both username and password are null
- If so, return a sentinel (e.g., `TestExecutionContext.Cancelled`) or handle in the calling loop to produce a `Skipped` result with message "Credentials not provided"

### User Story 3 — Path Traversal Prevention (FR-005)

**Goal**: Reject filenames containing path traversal characters in profile operations.

**Modified file**: `src/ReqChecker.Infrastructure/Profile/ProfileStorageService.cs`
- Add private method `ValidateFileName(string fileName)`:
  ```
  if (Path.GetFileName(fileName) != fileName)
      throw new ArgumentException("Invalid filename: must not contain path separators");
  if (fileName.Contains(".."))
      throw new ArgumentException("Invalid filename: must not contain path traversal");
  ```
- Call `ValidateFileName()` at the start of `DeleteProfile()` (before line 98)
- Call `ValidateFileName()` at the start of `ProfileExists()` (before line 119)
- `CopyProfileToUserDirectory()` already safe — uses `Path.GetFileName(sourcePath)` at line 78

### User Story 4 — Resource Lifecycle Management (FR-006, FR-007)

**Goal**: Fix event subscription leaks and dispose CancellationTokenSource.

**Modified file**: `src/ReqChecker.App/ViewModels/MainViewModel.cs`
- Add field: `private PropertyChangedEventHandler? _themePropertyChangedHandler;`
- In `OnThemeServiceChanged()`: create the handler as a stored field instead of anonymous lambda, subscribe with the field reference
- In `Dispose()`: unsubscribe `ThemeService.PropertyChanged -= _themePropertyChangedHandler`

**Modified file**: `src/ReqChecker.App/ViewModels/DiagnosticsViewModel.cs`
- Add `: IDisposable` to class declaration
- Add `Dispose()` method that unsubscribes `_appState.LastRunReportChanged -= OnLastRunReportChanged`

**Modified file**: `src/ReqChecker.App/ViewModels/RunProgressViewModel.cs`
- In `StartTestsAsync()` finally block, after `OnCompletion()`: add `Cts?.Dispose(); Cts = null;`

### User Story 5 — Async File I/O (FR-008)

**Goal**: Replace synchronous file operations with async equivalents in HistoryService.

**Modified file**: `src/ReqChecker.Infrastructure/History/HistoryService.cs`

**LoadHistoryAsync() changes**:
- Replace `await Task.Run(() => { ... File.ReadAllText(...) ... })` with direct `await File.ReadAllTextAsync(_historyPath)`
- Remove the `Task.Run` wrapper entirely
- Same for backup file read (line 85)

**SaveToFile() → SaveToFileAsync() changes**:
- Rename `SaveToFile()` to `async Task SaveToFileAsync()`
- Replace `File.WriteAllText(...)` with `await File.WriteAllTextAsync(...)`
- Replace `File.Copy(...)` with stream-based async copy or keep sync (File.Copy has no async equivalent — acceptable for small backup files)
- Update all callers: `SaveRunAsync()`, `DeleteRunAsync()`, `ClearHistoryAsync()` — replace `await Task.Run(() => SaveToFile())` with `await SaveToFileAsync()`

### User Story 6 — Theme Consistency (FR-010)

**Goal**: Replace hardcoded `#0078D4` with dynamic theme resource.

**Modified file**: `src/ReqChecker.App/Resources/Styles/Theme.xaml`
- Replace all 6 instances of `Stroke="#0078D4"` and `Value="#0078D4"` with `Stroke="{DynamicResource SystemAccentColorPrimaryBrush}"` or WPF-UI's accent brush resource
- The focus visual styles for Button, TextBox, PasswordBox, CheckBox, and Label all need updating

**Note**: FR-011 (encoding artifacts) and FR-012 (virtualization) were investigated and found to be false positives — no changes needed. See research.md D-008 and D-009.

---

## Scope Reductions from Research

The following Codex review findings were investigated and determined to require **no changes**:

1. **RetryPolicy exception handling** (D-006): Already correctly handles per-attempt failures
2. **Encoding artifacts in list views** (D-008): Bullet characters (U+2022) are intentional separators
3. **List virtualization** (D-009): Already properly implemented on all list views

This reduces the implementation scope from 12 to 9 functional requirements with actual code changes.
